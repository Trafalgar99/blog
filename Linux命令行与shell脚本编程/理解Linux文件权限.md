# 理解Linux文件权限

## Linux的安全性

Linux安全系统的核心是用户账户。每个能进入Linux系统的用户都会被分配唯一的用户账 户。用户对系统中各种对象的访问权限取决于他们登录系统时用的账户。 

用户权限是通过创建用户时分配的用户ID（User ID，通常缩写为UID）来跟踪的。UID是数 值，每个用户都有唯一的UID，但在登录系统时用的不是UID，而是登录名。

### /etc/passwd文件

Linux系统使用一个专门的文件来将用户的登录名匹配到对应的UID值。这个文件就是 /etc/passwd文件，它包含了一些与用户有关的信息。

root用户账户是Linux系统的管理员，固定分配给它的UID是0。

Linux系统会为各种各样的功能创建不同的用户账户，而这些账户并不是真的用户。这些账户叫作系统账 户，是系统上运行的各种服务进程访问资源用的特殊账户。所有运行在后台的服务都需要用一个 系统用户账户登录到Linux系统上。 

Linux为系统账户预留了500以下的UID值。有些服务甚至要用特定的UID才能正常工作。为普通用户创建账户时，，大多数Linux系统会从500开始，将第一个可用UID分配给这个账户（并非 所有的Linux发行版都是这样）。

/etc/passwd文件 的字段包含了如下信息： 

+ 登录用户名 
+ 用户密码 
+ 用户账户的UID（数字形式） 
+ 用户账户的组ID（GID）（数字形式） 
+ 用户账户的文本描述（称为备注字段） 
+ 用户HOME目录的位置 
+ 用户的默认shell 

现在，绝大多数Linux系统都将用户密码保存在另一个单独的文件中（叫作shadow文件，位置 在/etc/shadow）。只有特定的程序（比如登录程序）才能访问这个文件。 

### /etc/shadow文件

只有root用户才能访问/etc/shadow 文件，这让它比起/etc/passwd安全许多。 

/etc/shadow文件为系统上的每个用户账户都保存了一条记录。

如：
```
rich:$1$.FfcK0ns$f1UgiyHQ25wrB/hykCn020:11627:0:99999:7::: 
```
在/etc/shadow文件的每条记录中都有9个字段： 

+ 与/etc/passwd文件中的登录名字段对应的登录名 
+ 加密后的密码 
+ 自上次修改密码后过去的天数密码（自1970年1月1日开始计算） 
+ 多少天后才能更改密码 
+ 多少天后必须更改密码 
+ 密码过期前提前多少天提醒用户更改密码 
+ 密码过期后多少天禁用用户账户 
+ 用户账户被禁用的日期（用自1970年1月1日到当天的天数表示） 
+ 预留字段给将来使用 

使用shadow密码系统后，Linux系统可以更好地控制用户密码。它可以控制用户多久更改一 次密码，以及什么时候禁用该用户账户，如果密码未更新的话。 

### 添加新用户

用来向Linux系统添加新用户的主要工具是useradd。这个命令简单快捷，可以一次性创建 新用户账户及设置用户HOME目录结构。useradd命令使用系统的默认值以及命令行参数来设置 用户账户。

系统会将/etc/skel目录下的内容复制到用户的HOME目录下； 

默认情况下，useradd命令不会创建HOME目录，但是-m命令行选项会使其创建HOME目录。

> 运行本章中提到的用户账户管理命令，需要以root用户账户登录或者通过sudo命令以root 用户账户身份运行这些命令

### 删除用户

如果你想从系统中删除用户，userdel可以满足这个需求。默认情况下，userdel命令会只 删除/etc/passwd文件中的用户信息，而不会删除系统中属于该账户的任何文件。 

如果加上-r参数，userdel会删除用户的HOME目录以及邮件目录。然而，系统上仍可能存 有已删除用户的其他文件。这在有些环境中会造成问题。 

> 在有大量用户的环境中使用-r参数时要特别小心。你永远不知道用户是否在其HOME目 录下存放了其他用户或其他程序要使用的重要文件。记住，在删除用户的HOME目录之 前一定要检查清楚！ 

### 修改用户

![](image/2020-06-08-18-58-38.png)

**usermod**

usermod命令是用户账户修改工具中强大的一个。它能用来修改/etc/passwd文件中的大部 分字段，只需用与想修改的字段对应的命令行参数就可以了。参数大部分跟useradd命令的参数 一样（比如，-c修改备注字段，-e修改过期日期，-g修改默认的登录组）。除此之外，还有另外 一些可能派上用场的选项。

+ -l修改用户账户的登录名。 
+ -L锁定账户，使用户无法登录。 
+ -p修改账户的密码。 
+ -U解除锁定，使用户能够登录。 

-L选项尤其实用。它可以将账户锁定，使用户无法登录，同时无需删除账户和用户的数据。 要让账户恢复正常，只要用-U选项就行了。

**passwd和chpasswd**

系统上的任何用户都能改自己的密码，但只 有root用户才有权限改别人的密码

-e选项能强制用户下次登录时修改密码。你可以先给用户设置一个简单的密码，之后再强制 在下次登录时改成他们能记住的更复杂的密码。

chpasswd命令能从 标准输入自动读取登录名和密码对（由冒号分割）列表，给密码加密，然后为用户账户设置。你 也可以用重定向命令来将含有userid:passwd对的文件重定向给该命令。

**chsh、chfn和chage**

chsh、chfn和chage工具专门用来修改特定的账户信息。chsh命令用来快速修改默认的用 户登录shell。使用时必须用shell的全路径名作为参数，不能只用shell名。 

chfn命令提供了在/etc/passwd文件的备注字段中存储信息的标准方法。chfn命令会将用于 Unix的finger命令的信息存进备注字段，而不是简单地存入一些随机文本（比如名字或昵称之 类的），或是将备注字段留空。finger命令可以非常方便地查看Linux系统上的用户信息。 

> 出于安全性考虑，很多Linux系统管理员会在系统上禁用finger命令，不少Linux发行版 甚至都没有默认安装该命令。 

chage命令用来帮助管理用户账户的有效期。你需要对每个值设置多个参数
![](image/2020-06-08-19-53-20.png)

chage命令的日期值可以用下面两种方式中的任意一种： 

+ YYYY-MM-DD格式的日期 
+ 代表从1970年1月1日起到该日期天数的数值

---------------------------------------------------
## 使用Linux组

Linux系统采用了另外一个安全概念——组（group）。 

组权限允许多个用户对系统中的对象（比如文件、目录或设备等）共享一组共用的权限。

有些Linux发行版会创建一个组，把所有 用户都当作这个组的成员。遇到这种情况要特别小心，因为文件很有可能对其他用户也是可读的。 有些发行版会为每个用户创建单独的一个组，这样可以更安全一些。

每个组都有唯一的GID——跟UID类似，在系统上这是个唯一的数值。除了GID，每个组还 有唯一的组名。Linux系统上有一些组工具可以创建和管理你自己的组。

### /etc/group 文件

与用户账户类似，组信息也保存在系统的一个文件中。
和UID一样，GID在分配时也采用了特定的格式。系统账户用的组通常会分配低于500的GID 值，而用户组的GID则会从500开始分配。

/etc/group文件有4个字段： 

+ 组名
+ 组密码
+ GID
+ 属于该组的用户列表

组密码允许非组内成员通过它临时成为该组成员。这个功能并不很普遍，但确实存在。 

千万不能通过直接修改/etc/group文件来添加用户到一个组，要用usermod命令。在添加用户到不同的组之前，首先得创建组。 


> 用户账户列表某种意义上有些误导人。你会发现，在列表中，有些组并没有列出用户。 这并不是说这些组没有成员。当一个用户在/etc/passwd文件中指定某个组作为默认组时， 用户账户不会作为该组成员再出现在/etc/group文件中。

### 创建新组

groupadd命令可在系统上创建新组。 

在创建新组时，默认没有用户被分配到该组。groupadd命令没有提供将用户添加到组中的 选项，但可以用usermod命令来弥补这一点。 
```shell
# /usr/sbin/usermod -G shared rich  
# /usr/sbin/usermod -G shared test 
# tail /etc/group 
```

> 如果更改了已登录系统账户所属的用户组，该用户必须登出系统后再登录，组关系的更 改才能生效。 

> 为用户账户分配组时要格外小心。如果加了-g选项，指定的组名会替换掉该账户的默认 组。-G选项则将该组添加到用户的属组的列表里，不会影响默认组。 

### 修改组

在/etc/group文件中可以看到，需要修改的组信息并不多。groupmod命令可以修改已有组的 GID（加-g选项）或组名（加-n选项）。 

修改组名时，GID和组成员不会变，只有组名改变。由于所有的安全权限都是基于GID的， 你可以随意改变组名而不会影响文件的安全性。 

## 理解文件权限

### 使用文件权限符

ls命令可以用来查看Linux系统上的文件、目录和设备的权限。

输出结果的第一个字段就是描述文件和目录权限的编码。这个字段的第一个字符代表了对象的类型：

+ -代表文件
+ d代表目录
+ l代表链接
+ c代表字符型设备
+ b代表块设备
+ n代表网络设备

之后有3组三字符的编码。每一组定义了3种访问权限： 

+ r代表对象是可读
+ w代表对象是可写
+ x代表对象是可执行

若没有某种权限，在该权限位会出现单破折线。这3组权限分别对应对象的3个安全级别：

+ 对象的属主
+ 对象的属组
+ 系统其他用户

![](image/2020-06-09-17-36-16.png)

### 默认文件权限

umask命令用来设置所创建文件和目录 的默认权限。 

```shell
$ touch newfile
$ ls -al newfile
-rw-r--r--    1 rich     rich            0 Sep 20 19:16 newfile 
$
```

touch命令用分配给我的用户账户的默认权限创建了这个文件。umask命令可以显示和设置 这个默认权限。 

```shell
$ umask
0022
$
```

第一位代表了一项特别的安全特性，叫作粘着位（sticky bit）

后面的3位表示文件或目录对应的umask八进制值。

八进制模式的安全性设置先获取这3个rwx权限的值，然后将其转换成3位二进制值，用一个 八进制值来表示。在这个二进制表示中，每个位置代表一个二进制位。因此，如果读权限是唯一 置位的权限，权限值就是r--，转换成二进制值就是100，代表的八进制值是4。

![](image/2020-06-09-17-47-50.png)

八进制模式先取得权限的八进制值，然后再把这三组安全级别（属主、属组和其他用户）的 八进制值顺序列出。因此，八进制模式的值664代表属主和属组成员都有读取和写入的权限，而 其他用户都只有读取权限。

umask值只是个掩码。它会屏蔽掉不想授予该安全级别的权限。

要把umask值从对象的全权限值中减掉。对文件来说，全权限的值是666（所有用户都有读 和写的权限）；而对目录来说，则是777（所有用户都有读、写、执行权限）

文件一开始的权限是666，减去umask值022之后，剩下的文件权限就成了644

在大多数Linux发行版中，umask值通常会设置在/etc/profile启动文件中，不过 有一些是设置在/etc/login.defs文件中的（如Ubuntu）。可以用umask命令为默认umask设置指定一个新值。 

```shell
$ umask 026
$
```

umask值同样会作用在创建目录上。

-------------------------------------------------

## 改变安全性设置

如果你已经创建了一个目录或文件，需要改变它的安全性设置，在Linux系统上有一些工具 能够完成这项任务。

### 改变权限

chmod命令用来改变文件和目录的安全性设置。该命令的格式如下： 
```
chmod options mode file
```

mode参数可以使用八进制模式或符号模式进行安全性设置。八进制模式设置非常直观，直 接用期望赋予文件的标准3位八进制权限码即可。 

```shell
chmod 760 newfile
```

与通常用到的3组三字符权限字符不同，chmod命令采用了另一种方法。下面是在符号模式 下指定权限的格式。 
```
[ugoa…][[+-=][rwxXstugo…] 
```

第一组字符定义了权限作用的对象： 

+ u代表用户
+ g代表组
+ o代表其他
+ a代表上述所有

后面跟着的符号表示你是想在现有权限基础上增加权限（+），还是在现有权限基础 上移除权限（-），或是将权限设置成后面的值（=）。 

第三个符号代表作用到设置上的权限。额外的 设置有以下几项。 

+ X：如果对象是目录或者它已有执行权限，赋予执行权限。 
+ s：运行时重新设置UID或GID。 
+ t：保留文件或目录。 
+ u：将权限设置为跟属主一样。 
+ g：将权限设置为跟属组一样
+ o：将权限设置为跟其他用户一样。 

```
chmod o+r newfile
```

options为chmod命令提供了另外一些功能。-R选项可以让权限的改变递归地作用到文件和 子目录。你可以使用通配符指定多个文件，然后利用一条命令将权限更改应用到这些文件上。 

### 改变所属关系

chown命令用来改变文件的属主， chgrp命令用来改变文件的默认属组。 

chown命令的格式如下。 
```
chown options owner[.group] file
```

可用登录名或UID来指定文件的新属主。 

chown命令也支持同时改变文件的属主和属组。 
```
chown dan.shared newfile
```
可以只改变一个目录的默认属组。 
```
chown .rich newfile
```

如果你的Linux系统采用和用户登录名匹配的组名，可以只用一个条目就改变二者。 
```
chown test. newfile
```

chown命令采用一些不同的选项参数。-R选项配合通配符可以递归地改变子目录和文件的所 属关系。-h选项可以改变该文件的所有符号链接文件的所属关系。 

> 只有root用户能够改变文件的属主。任何属主都可以改变文件的属组，但前提是属主必须 是原属组和目标属组的成员。 

chgrp命令可以更改文件或目录的默认属组。 

用户账户必须是这个文件的属主，除了能够更换属组之外，还得是新组的成员。

这是Linux系统共享文件的一个途径。

-------------------------------------
## 共享文件

Linux系统上共享文件的方法是创建组。

创建新文件时，Linux会用你默认的UID和GID给文件分配权限。想 让其他人也能访问文件，要么改变其他用户所在安全组的访问权限，要么就给文件分配一个包含 其他用户的新默认属组。 

Linux还为每个文件和目录存储了3个额外的信息位。 

+ 设置用户ID（SUID）：当文件被用户使用时，程序会以文件属主的权限运行。 
+ 设置组ID（SGID）：对文件来说，程序会以文件属组的权限运行；对目录来说，目录中 创建的新文件会以目录的默认属组作为默认属组。 
+ 粘着位：进程结束后文件还驻留（粘着）在内存中。 

SGID位对文件共享非常重要。启用SGID位后，你可以强制在一个共享目录下创建的新文件都属于该目录的属组，这个组也就成为了每个用户的属组

SGID可通过chmod命令设置。它会加到标准3位八进制值之前（组成4位八进制值），或者在 符号模式下用符号s。 

![](image/2020-06-09-18-24-42.png)

要创建一个共享目录，使目录里的新文件都能沿用目录的属组，只需将该目录的SGID 位置位。 

```bash
$ mkdir testdir
$ ls -s-l
drwxrwxr-x    2 rich     rich         4096 Sep 20 23:12 testdir/ 
$ chgrp shared testdir
$ chmod g+s testdir
$ ls -l
drwxrwsr-x    2 rich     shared       4096 Sep 20 23:12 testdir/ 
$ umask 002
$ cd testdir
$ touch testfile
$ ls -l
total 0
-rw-rw-r--    1 rich     shared          0 Sep 20 23:13 testfile 
$
```
首先，用mkdir命令来创建希望共享的目录。然后通过chgrp命令将目录的默认属组改为包 含所有需要共享文件的用户的组（你必须是该组的成员）。后，将目录的SGID位置位，以保证 目录中新建文件都用shared作为默认属组

为了让这个环境能正常工作，所有组成员都需把他们的umask值设置成文件对属组成员可 写。在前面的例子中，umask改成了002，所以文件对属组是可写的。 

做完了这些，组成员就能到共享目录下创建新文件了。跟期望的一样，新文件会沿用目录的 属组，而不是用户的默认属组。现在shared组的所有用户都能访问这个文件了。 

